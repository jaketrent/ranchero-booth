"use strict";var __moduleName=void 0;console.log("App started");var canvas=document.querySelector(".canvas"),capture=document.querySelector(".capture"),chooseVid=document.querySelector(".chooseVid"),choose=document.querySelector(".choose"),download=document.querySelector(".download"),fileInput=document.querySelector(".file"),startover=document.querySelector(".startover"),video=document.querySelector(".video"),ctx=canvas.getContext("2d"),mouseIsDown=!1,stachePos={x:0,y:0},grabOffset={x:0,y:0},stache=document.createElement("img"),avatar=document.createElement("img"),vidFrame=document.createElement("img"),streaming=!1;navigator.getMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var isValidFileType=function(e){return e.type.match(/image.*/)},setupCanvas=function(){stateMgr.enter("canvasImg"),canvas.addEventListener("mousedown",function(e){grabStache(e,avatar)}),canvas.addEventListener("mousemove",function(e){moveStache(e,avatar)}),canvas.addEventListener("mouseup",function(e){releaseStache(e,avatar)}),stache.src="img/stache-swirl-sm.png",stache.onload=function(){redrawStache(avatar)}},readFile=function(e,t){var a=new FileReader;a.onload=function(e){t.src=e.target.result},a.readAsDataURL(e)},isHit=function(e,t){var a=stachePos.x<=e&&e<=stachePos.x+stache.width,o=stachePos.y<=t&&t<=stachePos.y+stache.height;return a&&o},saveGrabOffset=function(e,t){grabOffset={x:e,y:t}},saveStachePos=function(e,t){stachePos={x:e,y:t}},redrawStache=function(e){ctx.clearRect(0,0,canvas.width,canvas.height),ctx.drawImage(e,0,0,canvas.width,e.height*(canvas.height/e.width)),ctx.drawImage(stache,stachePos.x,stachePos.y,stache.width,stache.height)},getCoords=function(e,t){var a=e.getBoundingClientRect(),o=t.clientX-a.left,n=t.clientY-a.top;return[o,n]},addClass=function(e,t){e&&(e.classList?e.classList.add(t):e.className+=" "+t)},removeClass=function(e,t){e&&(e.classList?e.classList.remove(t):e.className=e.className.replace(new RegExp("(^|\\b)"+t.split(" ").join("|")+"(\\b|$)","gi")," "))},grabStache=function(e){var t=getCoords(canvas,e),a=t[0],o=t[1];isHit(a,o)&&(saveGrabOffset(a-stachePos.x,o-stachePos.y),mouseIsDown=!0)},moveStache=function(e,t){if(mouseIsDown){var a=getCoords(canvas,e),o=a[0],n=a[1];saveStachePos(o-grabOffset.x,n-grabOffset.y),redrawStache(t)}},releaseStache=function(){mouseIsDown=!1},downloadCanvas=function(){download.href=canvas.toDataURL("image/png")},clickFileInput=function(){var e=document.createEvent("HTMLEvents");e.initEvent("click",!0,!1),fileInput.dispatchEvent(e)},toArray=function(e){for(var t=[],a=0,o=t.length=e.length;o>a;a++)t[a]=e[a];return t},setupVideo=function(){stateMgr.enter("captureVid"),canvas.addEventListener("mousedown",function(e){grabStache(e,vidFrame)}),canvas.addEventListener("mousemove",function(e){moveStache(e,vidFrame)}),canvas.addEventListener("mouseup",function(e){releaseStache(e,vidFrame)}),navigator.getMedia({video:!0,audio:!1},function(e){if(navigator.mozGetUserMedia)video.mozSrcObject=e;else{var t=window.URL||window.webkitURL;video.src=t.createObjectURL(e)}video.play()},function(e){console.log("err"),console.log(e)}),video.addEventListener("canplay",function(){streaming||(video.setAttribute("width",canvas.width),video.setAttribute("height",video.videoHeight*(canvas.height/video.videoWidth)),canvas.setAttribute("width",canvas.width),canvas.setAttribute("height",canvas.height),streaming=!0)},!1)},captureVideoFrame=function(){stateMgr.enter("canvasVid"),ctx.drawImage(video,0,0,canvas.width,video.height),vidFrame.src=canvas.toDataURL("image/png"),vidFrame.onload=function(){stache.src="img/stache-swirl-sm.png",stache.onload=function(){redrawStache(vidFrame)}}},startOver=function(){stateMgr.enter("choose")},stateMgr={states:{choose:{add:{"is-hidden":".video, .capture, .canvas, .download, .startover"},remove:{"is-hidden":".chooseVid, .choose, .prompt"}},captureVid:{add:{"is-hidden":".choose, .chooseVid, .prompt"},remove:{"is-hidden":".video, .capture"}},canvasImg:{add:{"is-hidden":".choose, .chooseVid, .prompt"},remove:{"is-hidden":".canvas, .download, .startover"}},canvasVid:{add:{"is-hidden":".video, .capture"},remove:{"is-hidden":".canvas, .download, .startover"}}},enter:function(e){var t=stateMgr.states[e];t.add&&Object.keys(t.add).forEach(function(e){toArray(document.querySelectorAll(t.add[e])).forEach(function(t){addClass(t,e)})}),t.remove&&Object.keys(t.remove).forEach(function(e){toArray(document.querySelectorAll(t.remove[e])).forEach(function(t){removeClass(t,e)})})}};document.addEventListener("DOMContentLoaded",function(){fileInput.addEventListener("change",function(e){var t=e.target.files[0];return isValidFileType(t)?(avatar.onload=setupCanvas,void readFile(t,avatar)):void alert("Select an image file")}),stateMgr.enter("choose"),capture.addEventListener("click",captureVideoFrame),chooseVid.addEventListener("click",setupVideo),download.addEventListener("click",downloadCanvas),choose.addEventListener("click",clickFileInput),startover.addEventListener("click",startOver)});